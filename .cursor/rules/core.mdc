---
alwaysApply: true
description: SDK Core rules
globs: ["**/*"]
---

# Port SDK Security-First Development Rules

## ğŸ” Security is Priority #1

**CRITICAL**: Security must be the highest priority in all code changes. Every commit must be reviewed for security implications.

---

## 1. Dependency Security

### Package Management
- âœ… **ALWAYS** audit dependencies before adding: `pnpm audit`
- âœ… **NEVER** install packages without verifying source and reputation
- âœ… **REQUIRED**: Check package age, maintainership, and download stats on npmjs.com
- âœ… **REQUIRED**: Review package.json of dependencies for suspicious scripts
- âœ… **REQUIRED**: Pin exact versions in package.json (no `^` or `~`)
- âœ… **REQUIRED**: Run security scans on every dependency update

### Red Flags for Dependencies
- âŒ Package created in last 30 days (unless from trusted org)
- âŒ Package with < 1000 downloads/week (unless well-known)
- âŒ Package with no GitHub repo or suspicious repo
- âŒ Package with typosquatting similarity to popular packages
- âŒ Packages requesting unusual permissions
- âŒ Dependencies with known CVEs

### Allowed Dependencies
- âœ… Official packages from known organizations (@types, @port-labs, etc.)
- âœ… Well-established packages (> 1 year old, > 100k downloads/week)
- âœ… Packages with active maintenance and security track record

---

## 2. Credential & Secret Management

### Strict Rules
- âŒ **NEVER** hardcode credentials, API keys, or tokens
- âŒ **NEVER** log sensitive information (tokens, passwords, credentials)
- âŒ **NEVER** commit .env files or credentials to git
- âŒ **NEVER** expose credentials in error messages or stack traces
- âœ… **ALWAYS** use environment variables for sensitive data
- âœ… **ALWAYS** sanitize error messages before exposing to users
- âœ… **ALWAYS** validate .gitignore includes .env, *.key, *.pem, credentials.*

### Credential Validation
```typescript
// âœ… GOOD - No credentials in code
const apiKey = process.env.PORT_API_KEY;

// âŒ BAD - Hardcoded credential
const apiKey = "sk_live_1234567890";
```

---

## 3. Input Validation & Sanitization

### All User Input Must Be Validated
- âœ… **REQUIRED**: Validate all input parameters before use
- âœ… **REQUIRED**: Sanitize strings used in URLs, SQL, or commands
- âœ… **REQUIRED**: Use TypeScript strict mode for type safety
- âœ… **REQUIRED**: Validate lengths, formats, and ranges
- âŒ **NEVER** trust user input without validation
- âŒ **NEVER** execute user input as code
- âŒ **NEVER** interpolate user input directly into queries

### Examples
```typescript
// âœ… GOOD - Validated and sanitized
function getEntity(identifier: string): Promise<Entity> {
  if (!/^[a-zA-Z0-9_-]+$/.test(identifier)) {
    throw new ValidationError('Invalid identifier format');
  }
  return this.httpClient.get(`/entities/${encodeURIComponent(identifier)}`);
}

// âŒ BAD - No validation
function getEntity(identifier: string): Promise<Entity> {
  return this.httpClient.get(`/entities/${identifier}`); // Injection risk!
}
```

---

## 4. Error Handling & Information Disclosure

### Secure Error Handling
- âœ… **REQUIRED**: Catch and handle all errors appropriately
- âœ… **REQUIRED**: Return generic error messages to users
- âœ… **REQUIRED**: Log detailed errors securely (not to user-facing output)
- âŒ **NEVER** expose stack traces to users
- âŒ **NEVER** expose internal paths or system information
- âŒ **NEVER** expose database queries or internal logic

### Examples
```typescript
// âœ… GOOD - Safe error handling
try {
  await dangerousOperation();
} catch (error) {
  // Log detailed error internally
  console.error('Internal error:', error);
  // Return generic message to user
  throw new PortError('Operation failed. Please try again.');
}

// âŒ BAD - Exposes internals
try {
  await dangerousOperation();
} catch (error) {
  throw new Error(`Database query failed: ${error.stack}`); // Leaks info!
}
```

---

## 5. Network & Communication Security

### HTTPS Only
- âœ… **REQUIRED**: Use HTTPS for all API communication
- âœ… **REQUIRED**: Validate TLS certificates (no `rejectUnauthorized: false`)
- âœ… **REQUIRED**: Use secure proxy configurations
- âŒ **NEVER** allow HTTP connections to API endpoints
- âŒ **NEVER** disable SSL verification

### Proxy Security
- âœ… **REQUIRED**: Support corporate proxies securely
- âœ… **REQUIRED**: Respect NO_PROXY environment variable
- âœ… **REQUIRED**: Handle proxy authentication securely
- âŒ **NEVER** log proxy credentials

---

## 6. Code Quality & Security Practices

### TypeScript Security
- âœ… **REQUIRED**: Use strict TypeScript mode
- âœ… **REQUIRED**: No `any` types (use `unknown` if needed)
- âœ… **REQUIRED**: Enable all strict compiler options
- âœ… **REQUIRED**: Use readonly where possible
- âŒ **NEVER** use `eval()`, `Function()`, or `setTimeout(string)`
- âŒ **NEVER** use `@ts-ignore` without security review
- âŒ **NEVER** disable TypeScript checks for convenience

### Secure Coding Patterns
```typescript
// âœ… GOOD - Type-safe and secure
function processData(data: unknown): ProcessedData {
  if (!isValidData(data)) {
    throw new ValidationError('Invalid data format');
  }
  return transformData(data);
}

// âŒ BAD - Unsafe type assertion
function processData(data: any): ProcessedData {
  return data as ProcessedData; // No validation!
}
```

---

## 7. Authentication & Authorization

### Token Management
- âœ… **REQUIRED**: Store tokens securely in memory only
- âœ… **REQUIRED**: Clear tokens on logout or error
- âœ… **REQUIRED**: Implement token expiry and refresh
- âœ… **REQUIRED**: Use secure token transmission (HTTPS)
- âŒ **NEVER** store tokens in localStorage or cookies (in browser contexts)
- âŒ **NEVER** transmit tokens in URL parameters
- âŒ **NEVER** log authentication tokens

### OAuth Security
- âœ… **REQUIRED**: Use PKCE for OAuth flows (when applicable)
- âœ… **REQUIRED**: Validate OAuth state parameters
- âœ… **REQUIRED**: Use secure redirect URIs

---

## 8. Rate Limiting & DoS Prevention

### Protection Mechanisms
- âœ… **REQUIRED**: Implement client-side rate limiting
- âœ… **REQUIRED**: Handle 429 (Rate Limit) responses appropriately
- âœ… **REQUIRED**: Use exponential backoff for retries
- âœ… **REQUIRED**: Set reasonable timeouts on all requests
- âŒ **NEVER** retry indefinitely
- âŒ **NEVER** overwhelm the API with concurrent requests

---

## 9. Testing & Validation

### Security Testing Requirements
- âœ… **REQUIRED**: Test all error paths
- âœ… **REQUIRED**: Test with invalid/malicious input
- âœ… **REQUIRED**: Test authentication failures
- âœ… **REQUIRED**: Test rate limiting and timeouts
- âœ… **REQUIRED**: Run security scans before releases

### Pre-Commit Checklist
- [ ] No hardcoded credentials or secrets
- [ ] All inputs validated and sanitized
- [ ] Error messages don't leak sensitive info
- [ ] No new dependencies without security review
- [ ] TypeScript strict mode passes
- [ ] Tests cover security scenarios
- [ ] `pnpm audit` shows no high/critical vulnerabilities

---

## 10. Dependency Security Scanning

### Required Scans
```bash
# Before every commit
pnpm audit

# Before every release
pnpm audit --audit-level=moderate

# Check for outdated packages
pnpm outdated

# Update with caution
pnpm update --interactive
```

### Vulnerability Response
- **CRITICAL**: Patch within 24 hours
- **HIGH**: Patch within 7 days
- **MODERATE**: Patch within 30 days
- **LOW**: Patch in next release cycle

---

## 11. Code Review Security Checklist

Before approving any PR, verify:

### Credentials & Secrets
- [ ] No hardcoded credentials
- [ ] No committed .env files
- [ ] No API keys in code or comments
- [ ] Sensitive data properly redacted in logs

### Input Validation
- [ ] All user input validated
- [ ] URL parameters properly encoded
- [ ] No SQL/command injection vectors
- [ ] No eval() or similar dangerous functions

### Dependencies
- [ ] New dependencies justified and reviewed
- [ ] Dependencies from trusted sources
- [ ] No suspicious package names
- [ ] `pnpm audit` passes

### Error Handling
- [ ] Errors caught and handled
- [ ] No stack traces exposed to users
- [ ] Error messages don't leak internals
- [ ] Logging doesn't include sensitive data

### Network Security
- [ ] HTTPS used for all API calls
- [ ] SSL certificates validated
- [ ] Timeouts configured
- [ ] Rate limiting respected

---

## 12. Security Documentation

### Required Documentation
- âœ… Document all security considerations
- âœ… Provide secure usage examples
- âœ… Document credential management
- âœ… Document proxy configuration
- âœ… Maintain security changelog

---

## 13. Incident Response

### If Security Issue Detected
1. **STOP**: Don't commit or deploy
2. **ASSESS**: Determine severity and scope
3. **FIX**: Implement secure solution
4. **TEST**: Verify fix doesn't introduce new issues
5. **DOCUMENT**: Update security docs and changelog
6. **NOTIFY**: Inform stakeholders if user-impacting

---

## 14. Regular Security Maintenance

### Weekly Tasks
- [ ] Review dependency security advisories
- [ ] Check for outdated packages
- [ ] Review recent security bulletins

### Monthly Tasks
- [ ] Full security audit of codebase
- [ ] Update dependencies (with testing)
- [ ] Review and update security documentation

### Before Each Release
- [ ] Complete security audit
- [ ] Update all dependencies safely
- [ ] Run comprehensive security tests
- [ ] Review CHANGELOG for security fixes

---

## Security Resources

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Node.js Security Best Practices](https://nodejs.org/en/docs/guides/security/)
- [npm Security Best Practices](https://docs.npmjs.com/security-best-practices)
- [Snyk Security Database](https://security.snyk.io/)

---

## Summary: Security-First Mindset

**Remember**: Security is not a feature, it's a requirement. Every line of code must be written with security in mind. When in doubt, choose the more secure option.

### Golden Rules
1. ğŸ” Never trust user input
2. ğŸ”’ Never hardcode credentials
3. ğŸ›¡ï¸ Validate everything
4. ğŸ” Audit dependencies religiously
5. ğŸ“ Log securely, never expose secrets
6. ğŸš« Fail securely, never leak information
7. ğŸ”„ Keep dependencies updated
8. ğŸ§ª Test security scenarios
9. ğŸ“š Document security considerations
10. ğŸš¨ Report issues immediately

